# Watchdog Dashboard â€” Design Document

**Date:** 2026-02-19
**Status:** Approved

## Overview

Replace the verbose Slack digest with a compact summary linking to a web dashboard. The dashboard shows all violations from a run, organized by check, with inline actions (View in HubSpot, Add Exception, Mark as Fixed). This unblocks scaling the Watchdog to more checks without hitting Slack message limits.

---

## Problem

The Slack digest lists up to 5 items per check with full details. With 11+ checks potentially failing, the message becomes a wall of text that's hard to scan and act on. Slack Block Kit also has message size limits that we'll hit as checks grow.

---

## Architecture

Three layers, no new infrastructure:

```
Slack (compact summary + link)
    â†“
React Dashboard (/watchdog route in existing app)
    â†“
Supabase (read violations, write exceptions/resolutions)
```

### What changes where

| Layer | Change |
|-------|--------|
| **Slack** | Simplified to 3-line summary + dashboard link |
| **React app** | New `/watchdog` and `/watchdog/run/:id` routes |
| **Supabase** | Add `run_id`, `run_type`, `resolutions` columns to `watchdog_results` |
| **n8n coordinators** | Generate `run_id`, pass to checks, simplify Slack formatter |
| **Check sub-workflows** | No changes |

---

## Data Model Changes

### `watchdog_results` â€” new columns

```sql
ALTER TABLE watchdog_results ADD COLUMN run_id uuid;
ALTER TABLE watchdog_results ADD COLUMN run_type text; -- 'daily' or 'hourly'
ALTER TABLE watchdog_results ADD COLUMN resolutions jsonb DEFAULT '{}';
```

**`run_id`** â€” UUID generated by the coordinator at the start of each run. Groups all check results from one execution. This is what the dashboard URL links to.

**`run_type`** â€” `'daily'` or `'hourly'`. Used for display and filtering.

**`resolutions`** â€” Per-violation resolution status, keyed by `record_id`:

```json
{
  "123": { "status": "fixed", "resolved_by": "idan", "resolved_at": "2026-02-19T10:00:00Z" },
  "456": { "status": "exception", "exception_id": "uuid-of-exception" }
}
```

### `watchdog_exceptions` â€” no changes needed

Existing schema already supports the "Add Exception" action:

| Column | Used for |
|--------|----------|
| `check_id` | Which check to skip |
| `type` | `record` or `pattern` |
| `value` | The record ID or pattern to match |
| `reason` | Why it's excluded |
| `active` | Toggle on/off |

### No new tables required

---

## Coordinator Workflow Changes

### Generate `run_id`

New Code node at the start of both coordinators:

```javascript
const crypto = require('crypto');
const run_id = crypto.randomUUID();
return [{ json: { run_id } }];
```

The `run_id` is passed as a query parameter when calling each check's webhook, and included when saving results to Supabase.

### Simplified Slack Digest

Replace the verbose Block Kit message with a compact summary:

```
ğŸ” HubSpot Watchdog â€” Daily Report
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ 3 Critical  |  ğŸŸ  5 High  |  ğŸŸ¡ 2 Medium  |  âœ… 4 Passed

ğŸ‘‰ View full report: https://reindeer-sal.vercel.app/watchdog/run/<run_id>
```

### What stays the same

- All 11 check sub-workflows â€” untouched
- Check webhook format â€” same standardized result JSON
- Supabase result storage â€” same insert, just adds `run_id` and `run_type`

---

## Dashboard UI

### Tech Stack

- React 18 + Tailwind CSS (existing app stack)
- Supabase JS client for data access
- React Router for `/watchdog` routes
- Deployed on Vercel (same as SAL form)

### Page 1: Run List (`/watchdog`)

A clean table showing recent runs, sorted newest first:

| Column | Content |
|--------|---------|
| Timestamp | When the run happened |
| Type | Daily / Hourly badge |
| Summary | "3 Critical, 5 High, 2 Medium" with colored severity badges |
| Resolved | "4/10 resolved" progress indicator |
| Action | "View" button â†’ navigates to run detail |

### Page 2: Run Detail (`/watchdog/run/:id`)

**Top bar:**
- Run timestamp, type badge, overall stats
- Filter pills: All | Critical | High | Medium
- Progress: "4/10 violations resolved"

**Main content â€” violations grouped by check:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš  Missing Company Source (3 found)        HIGH  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Acme Inc                                        â”‚
â”‚ Missing company source field                    â”‚
â”‚ [View in HubSpot]  [Add Exception]  [Mark Fixed]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Beta Corp                                       â”‚
â”‚ Missing company source field                    â”‚
â”‚ [View in HubSpot]  [Add Exception]  [Mark Fixed]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”´ Orphaned Deals (2 found)           CRITICAL  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Per-violation row:**
- Record name + details text
- Three action buttons inline
- Visual state change when resolved (greyed out / strikethrough + "Fixed" or "Exception" tag)

**Styling:**
- Tailwind, consistent with SAL form
- Severity colors: red for critical, orange for high, yellow for medium
- Resolved items greyed out with tag

### V1 Actions

All three actions talk directly to Supabase â€” no n8n webhooks needed for v1:

| Action | What it does |
|--------|-------------|
| **View in HubSpot** | Opens `hubspot_url` in new tab |
| **Add Exception** | Writes to `watchdog_exceptions` (check_id, type: "record", value: record_id, reason from prompt) |
| **Mark as Fixed** | Updates `resolutions` JSONB in `watchdog_results` for that record_id |

Future phases will add n8n-triggered actions (Merge, Fix Status, Fix Associate) as those workflows are built.

---

## Implementation Steps

| Step | What |
|------|------|
| 1 | Add `run_id`, `run_type`, `resolutions` columns to `watchdog_results` in Supabase |
| 2 | Build React dashboard â€” install react-router, create run list page, create run detail page, wire up Supabase client |
| 3 | Update daily coordinator â€” add `run_id` generation node, pass to checks, update Supabase insert, simplify Slack formatter |
| 4 | Update hourly coordinator â€” same changes as daily |
| 5 | Test end-to-end: trigger a run, see compact Slack summary, click link, view dashboard, use all three actions |

---

## Future Extensions

As Watchdog phases progress, the dashboard grows with them:

| Phase | Dashboard additions |
|-------|-------------------|
| Phase 3 (AI checks) | Root cause explanations shown per violation |
| Phase 4 (Feedback) | Action buttons: Merge, Fix Status, Fix Associate (trigger n8n webhooks) |
| Phase 5 (Real-time) | Live updates / auto-refresh when new violations arrive |
